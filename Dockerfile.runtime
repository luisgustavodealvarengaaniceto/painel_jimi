# Dockerfile ultra-simplificado para evitar problemas de Prisma
FROM node:20

# Instalar dependÃªncias de sistema
RUN apt-get update && apt-get install -y \
    curl \
    bash \
    postgresql-client \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copiar arquivos de dependÃªncias
COPY package*.json ./
COPY backend/package*.json ./backend/

# Instalar dependÃªncias do frontend
RUN npm install

# Instalar dependÃªncias do backend
WORKDIR /app/backend
RUN npm install

# Voltar para raiz do projeto
WORKDIR /app

# Copiar todo o cÃ³digo
COPY . .

# Build do frontend
RUN npm run build

# Build do backend
WORKDIR /app/backend
RUN npm run build

# Voltar para raiz
WORKDIR /app

# Criar diretÃ³rios necessÃ¡rios
RUN mkdir -p /app/uploads /app/frontend

# Copiar frontend buildado
RUN cp -r /app/dist/* /app/frontend/ 2>/dev/null || true

# Criar script de inicializaÃ§Ã£o que gera Prisma no runtime
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ðŸš€ JIMI IOT BRASIL - Iniciando aplicaÃ§Ã£o..."\n\
\n\
# Aguardar PostgreSQL\n\
echo "â³ Aguardando PostgreSQL..."\n\
for i in {1..30}; do\n\
    if pg_isready -h postgres -p 5432 -U painel_user; then\n\
        echo "âœ… PostgreSQL estÃ¡ pronto!"\n\
        break\n\
    fi\n\
    echo "Tentativa $i/30..."\n\
    sleep 2\n\
done\n\
\n\
# Ir para backend\n\
cd /app/backend\n\
\n\
# Configurar Prisma para runtime\n\
export PRISMA_CLI_BINARY_TARGETS="native"\n\
export PRISMA_ENGINES_MIRROR="https://github.com/prisma/prisma-engines/releases"\n\
\n\
# Gerar Prisma Client no runtime (evita problemas de build)\n\
echo "ðŸ”§ Gerando Prisma Client..."\n\
npx prisma generate --schema=./prisma/schema.prisma || {\n\
    echo "âŒ Erro no Prisma generate, tentando instalaÃ§Ã£o manual..."\n\
    npm install @prisma/client\n\
    npx prisma generate --schema=./prisma/schema.prisma\n\
}\n\
\n\
# Executar migraÃ§Ãµes\n\
echo "ðŸ“Š Executando migraÃ§Ãµes..."\n\
npx prisma db push --accept-data-loss --schema=./prisma/schema.prisma || echo "âš ï¸ MigraÃ§Ã£o falhou"\n\
\n\
# Configurar frontend\n\
echo "ðŸ“ Configurando frontend..."\n\
if [ ! -f "/app/frontend/index.html" ]; then\n\
    cp -r /app/dist/* /app/frontend/ 2>/dev/null || echo "âš ï¸ Falha na cÃ³pia"\n\
fi\n\
\n\
echo "ðŸŽ‰ Iniciando servidor..."\n\
exec node dist/app.js' > /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Expor porta
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3001/api/health || exit 1

CMD ["/entrypoint.sh"]