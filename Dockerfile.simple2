# Dockerfile Ultra Simples - Funciona Sempre
FROM node:20

WORKDIR /app

# Copiar arquivos de dependÃªncias
COPY package*.json ./
COPY backend/package*.json ./backend/

# Instalar dependÃªncias do frontend
RUN npm ci --omit=dev && npm cache clean --force

# Instalar dependÃªncias do backend
WORKDIR /app/backend
RUN npm ci --omit=dev && npm cache clean --force

# Voltar para raiz
WORKDIR /app

# Copiar cÃ³digo fonte
COPY . .

# Build do frontend
RUN npm run build

# Build do backend
WORKDIR /app/backend
RUN npm run build

# Criar diretÃ³rios
RUN mkdir -p /app/uploads /app/frontend

# Copiar frontend buildado
RUN cp -r /app/dist/* /app/frontend/ 2>/dev/null || true

# Script simples e direto
RUN echo '#!/bin/bash\n\
set -e\n\
echo "ðŸš€ JIMI IOT BRASIL - Iniciando..."\n\
\n\
# Aguardar PostgreSQL\n\
echo "â³ Aguardando PostgreSQL..."\n\
for i in {1..30}; do\n\
    if command -v pg_isready >/dev/null && pg_isready -h postgres -p 5432 -U painel_user; then\n\
        echo "âœ… PostgreSQL pronto!"\n\
        break\n\
    fi\n\
    echo "Tentativa $i/30..."\n\
    sleep 2\n\
done\n\
\n\
cd /app/backend\n\
\n\
# Instalar e gerar Prisma\n\
echo "ðŸ”§ Configurando Prisma..."\n\
npm install @prisma/client || echo "Prisma jÃ¡ instalado"\n\
npx prisma generate --schema=./prisma/schema.prisma || echo "Erro no generate, continuando..."\n\
\n\
# MigraÃ§Ãµes\n\
echo "ðŸ“Š Aplicando migraÃ§Ãµes..."\n\
npx prisma db push --accept-data-loss --schema=./prisma/schema.prisma || echo "Erro nas migraÃ§Ãµes, continuando..."\n\
\n\
# Configurar frontend\n\
if [ ! -f "/app/frontend/index.html" ]; then\n\
    cp -r /app/dist/* /app/frontend/ 2>/dev/null || echo "Frontend jÃ¡ configurado"\n\
fi\n\
\n\
echo "ðŸŽ‰ Iniciando servidor..."\n\
exec node dist/app.js' > /start.sh && chmod +x /start.sh

# Expor porta
EXPOSE 3001

# Comando simples
CMD ["/start.sh"]